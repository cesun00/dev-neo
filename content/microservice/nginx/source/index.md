---
title: "Analytical Commentary: Nginx Source Guide"
date: 2024-01-01
lastmod: 2024-05-01
draft: true
---

## Environment Setup

### Build from source with debug flags

```bash
hg clone https://hg.nginx.org/nginx
# a linux build can be done without os/win32
rm -rf nginx/src/os/win32
mkdir install
cd nginx
./auto/configure --with-debug --prefix="$(realpath ../install)" --with-cc-opt='-ggdb3 -O0'
make -j8
make install
```

Note: By default nginx does out-of-source build in a directory called `objs/`. Call `configure` with `--builddir=` flag to change it. **Do not name your custom build directory `build`, it shadows the `build` goal in the main `Makefile`.** (yes, nginx folks don't use `.PHONY`)

`--with-debug` will define the `NGX_DEBUG` macro to 1, enabling logging functions for debug in `core/ngx_log.h`.

`-ggdb3` flag is real: search for `-ggdblevel` in `man gcc`. The `configure` script will generate a `objs/Makefile` that use `-g` by default. `-ggdb3` will be appended to the end of the `CFLAGS` variable, thus override the insufficient `-g`:

Nginx by default enable `-O`. We override it with `-O0`. `man gcc` recommends using `-Og` over `-O0` for debugging, BUT `-Og` still optimizes out too much variables for me, and some return statements are eliminated, so you can't breakpoint on them, so no.

![foo](plen.png)

(Important flag variable `plen` is optimized out under `-Og`.)

```bash
$ head objs/Makefile  | grep CFLAGS
CFLAGS =  -pipe  -O -W -Wall -Wpointer-arith -Wno-unused-parameter -Werror -g -ggdb3 -O0
```

### Test compiled executable

```bash
cd nginx_install
# change conf/nginx.conf to use non-privileged port.
./sbin/nginx
curl localhost:8000
./sbin/nginx -s quit
```


### Config for Debug

By default the `nginx` executable after invoked, will (exec or fork-exec?) the master process, which read the conf file and spawn the worker processes. 2 conf directives affect this behavior:

1. `daemon on|off;` (default: `on`)
    
    Set to `off` to prevent the `nginx` executable from detaching from the terminal. This allows the shell to forward all keyboard event signals (e.g. `Ctrl-C` for `SIGINT`) directly to the master (and workers?) process. There will still be master and worker processes, all connected to the same terminal.

2. `master_process on|off;` (default: `on`)

    Set to `off` to prevent the `nginx` executable process from spawning the master process **and** worker processes. It will be the only process of nginx, handling everything.

By default all nginx processes prints nothing to `stdout` or `stderr`. `error_log` can be printed to `stderr` by using the `error_log stderr;` conf directive or the `-e stderr` CLI flag. There is no way for HTTP `access_log` to be printed to `stdout` or `stderr`.

Special Headers
--------------

### Config & Core

`ngx_config.h` and `ngx_core.h` must be included **at the very beginning** of all translation units source in nginx. You must `#include <ngx_config.h>` first, then `#include <ngx_core.h>`.

`#include <ngx_config.h>` brings important feature test macros like `_GNU_SOURCE`, so that all headers being included after that line can benefit from it. It also:

- includes `ngx_auto_headers.h`, which will be generated by the `configure` script at build time in the `--builddir`, to understand OS types and features.
- On linux, the macro `NGX_LINUX` will be defined to `1`, thus the platform-specific `ngx_linux_config.h` will be included. 

`ngx_linux_config.h`:

- `<sys/types.h>` defines `u_char` on linux. ([about `u_char`](https://stackoverflow.com/questions/1918934/is-u-char-a-standard))
- includes standard headers e.g. `stdio.h`, `stdlib.h`; maybe Igor forgets to merge those includes into `ngx_config.h`.

`ngx_core.h`:
- includes lots of common utilities headers, e.g. the ones for time,socket, regex, data structures, log, memory pool, etc.
- Lots of `struct xxx_s` are typedef-ed to `xxx_t` for convenience.
- 7 nginx standard return code and other utility macros are defined.

### Build-time Config / Feature Testing

`ngx_auto_config.h` and `ngx_auto_headers.h` will be generated at build time in `--builddir`. All definitions presented are defined to 1, and absent macros are considered disabled.

`ngx_auto_config.h` contains macro definitions regarding:

- build environment information, e.g.
	- `NGX_PTR_SIZE`: the size of a pointer in the current system.
	- `NGX_SYS_NERR`: Number of `errno` supported by the system, assuming consecutive and right-exclusive: `[0,NGX_SYS_NERR)`.
- available OS features, e.g. `NGX_HAVE_EPOLL` indicates `epoll` is available.
- `./configure` flags, either defaulted or overwritten on the command line.

`ngx_auto_headers.h` contains macro definitions regarding OS type and availability of important system headers.

- `NGX_LINUX`: is building for linux.
- `NGX_HAVE_XXX_H`: header `<xxx.h>` is available.

OS-specific Code and OS-conditioned Compilation
--------------

`os/unix/ngx_os.h`:

- provides declaration of common types/globals/functions on all POSIX systems. Implementations of `ngx_os_specific_[init|status]()` are OS-dependent, and are defined in respective `ngx_<OS>_init.c` file, while implementation of other functions are common POSIX and defined in `ngx_posix_init.c`, `ngx_process.c`, `ngx_daemon.c`, etc.
- conditionally includes a OS-specific header based on the system type in `ngx_auto_headers.h` (in my case `NGX_LINUX`, and includes `<ngx_linux.h>`), which brings declarations of OS-dependent types/globals/functions that can be used in ad-hoc conditional compilation section across the codebase. (`<ngx_linux.h>` only declares 1 more function.) Implementation of such functions are always OS-dependent, defined in `ngx_<OS>.c`.

The `Makefile` generated by `configure` scripts controls which files are compiled and linked together, thus provides correct OS-specific symbols.

FileSystem I/O
---------------

### `ngx_open_file_t` (`core/ngx_conf_file.h`)

The simplest structure file that
1. wraps a fd,
2. embeds the name of the file, and 
3. functions that work with it don't log. (since the logger type `ngx_log_t` embeded a pointer to this type, logging will cause infinite recursion.)

```c
// add `ngx_open_file_t` to cycle
ngx_open_file_t *ngx_conf_open_file(ngx_cycle_t *cycle, ngx_str_t *name);
```

### `ngx_file_t` (`core/ngx_file.h`)


## Network I/O

### `ngx_connection_t`
